# Генератор машинного кода на основе LR парсера

Этот репозиторий содержит код программы, которая способна по набору правил соответствия синтаксических конструкций
машинным командам генерировать эффективный код для целевой платформы. Это реализация идеи описаной в главе 8.9
книги "Копиляторы, принципы, технологии и инструменты".

## Описание

Проблема генерации эффективного кода традиционно решается таким образом: сначала генерируется какой-то код,
потом он оптимизируется. Это не очень хорошо, потому что оптимизация машинного кода дело не простое. По этой
причине максимальное число оптимизаций создатели компиляторов стремятся выполнить на более ранних этапах.
С другой стороны, генерировать хороший машинный код трудно. Это связано с избыточностью набора машинных инструкций
и большим количеством режимов адресации. В качестве простейшего примера можно привести запись в переменную на стеке.

```
a = b; // предположим, значение b уже находится в eax
```

В архитектуре x86 это можно сделать несколькими способами. Можно вычислить в регистре адрес соответствующей
переменной, а дельше записать данные по этому адресу.

```
mov     esi, ebp
add     esi, -4
mov     [sdi], eax
```

С другой стороны, есть специальный режим адресации, который позволяет выполнить запись в переменную 
относительно регистра EBP.

```
mov     [ebp-4], eax
```

Предлагаемая схема трансляции позволяет в данном случае сразу сгенерировать оптимальный код.

# Пример

В файле `data/rules.txt` находится описание описание кодогенератора. Оно состоит из паттернов синтаксического дерева 
промежуточного кода и команд, который будут им соответствовать.

Правила имеют вид:

```
A -> B [C] {D}
```

A - это новый нетерминал, на который должен быть заменён фрагмент синтаксического дерева.

B - это фрагмент синтексического дерева в префиксной форме.

C - условие применения данного правила. Правило применяется, только если условие выполненно.

D - команды, которые должны быть выполнены, при сворачивании фрагмента синтаксического дерева по данному правилу.
Здесь могут находиться команды, генерирующие код.

В файле `data/code.ir` содержится пример промежуточного кода для которого мы генерируем машинный код.

### Отладочная информация

#### Полученый код

```
LD R0, #a
ADD R0, R0, Rsp
ADD R0, R0, i(Rsp)
LD R1, b
INC R1
ST *R0, R1
(^.^) SUCCESS (^.^)
```

#### Каноническое множество пунктов

```
I0
    0: $START$ -> . S
    1: S -> . M
    2: M -> . = M R
    3: M -> . = ind R R
    4: M -> . memory
I1
    0: $START$ -> S .
I2
    0: S -> M .
I3
    0: M -> = . M R
    1: M -> = . ind R R
    2: M -> . = M R
    3: M -> . = ind R R
    4: M -> . memory
I4
    0: M -> memory .
I5
    0: M -> = M . R
    1: R -> . C
    2: R -> . M
    3: R -> . ind + C R
    4: R -> . + R ind + C R
    5: R -> . + R R
    6: R -> . + R C
    7: R -> . register
    8: M -> . = M R
    9: M -> . = ind R R
   10: M -> . memory
I6
    0: M -> = ind . R R
    1: R -> . C
    2: R -> . M
    3: R -> . ind + C R
    4: R -> . + R ind + C R
    5: R -> . + R R
    6: R -> . + R C
    7: R -> . register
    8: M -> . = M R
    9: M -> . = ind R R
   10: M -> . memory
I7
    0: M -> = M R .
I8
    0: R -> M .
I9
    0: R -> C .
I10
    0: R -> ind . + C R
I11
    0: R -> + . R ind + C R
    1: R -> + . R R
    2: R -> + . R C
    3: R -> . C
    4: R -> . M
    5: R -> . ind + C R
    6: R -> . + R ind + C R
    7: R -> . + R R
    8: R -> . + R C
    9: R -> . register
   10: M -> . = M R
   11: M -> . = ind R R
   12: M -> . memory
I12
    0: R -> register .
I13
    0: M -> = ind R . R
    1: R -> . C
    2: R -> . M
    3: R -> . ind + C R
    4: R -> . + R ind + C R
    5: R -> . + R R
    6: R -> . + R C
    7: R -> . register
    8: M -> . = M R
    9: M -> . = ind R R
   10: M -> . memory
I14
    0: R -> ind + . C R
I15
    0: R -> + R . ind + C R
    1: R -> + R . R
    2: R -> + R . C
    3: R -> . C
    4: R -> . M
    5: R -> . ind + C R
    6: R -> . + R ind + C R
    7: R -> . + R R
    8: R -> . + R C
    9: R -> . register
   10: M -> . = M R
   11: M -> . = ind R R
   12: M -> . memory
I16
    0: M -> = ind R R .
I17
    0: R -> ind + C . R
    1: R -> . C
    2: R -> . M
    3: R -> . ind + C R
    4: R -> . + R ind + C R
    5: R -> . + R R
    6: R -> . + R C
    7: R -> . register
    8: M -> . = M R
    9: M -> . = ind R R
   10: M -> . memory
I18
    0: R -> + R R .
I19
    0: R -> + R C .
    1: R -> C .
I20
    0: R -> + R ind . + C R
    1: R -> ind . + C R
I21
    0: R -> ind + C R .
I22
    0: R -> + R ind + . C R
    1: R -> ind + . C R
I23
    0: R -> + R ind + C . R
    1: R -> ind + C . R
    2: R -> . C
    3: R -> . M
    4: R -> . ind + C R
    5: R -> . + R ind + C R
    6: R -> . + R R
    7: R -> . + R C
    8: R -> . register
    9: M -> . = M R
   10: M -> . = ind R R
   11: M -> . memory
I24
    0: R -> + R ind + C R .
    1: R -> ind + C R .
```

#### Таблицы Action и Goto LR-парсера

```
+--+--------+--------+--------+--------+--------+--------+--------+
|  |       C|       =|     ind|       +|register|  memory|       $|
+--+--------+--------+--------+--------+--------+--------+--------+
| 0|        |    [s3]|        |        |        |    [s4]|        |
+--+--------+--------+--------+--------+--------+--------+--------+
| 1|        |        |        |        |        |        |   [acc]|
+--+--------+--------+--------+--------+--------+--------+--------+
| 2|        |        |        |        |        |        |    [r1]|
+--+--------+--------+--------+--------+--------+--------+--------+
| 3|        |    [s3]|    [s6]|        |        |    [s4]|        |
+--+--------+--------+--------+--------+--------+--------+--------+
| 4|   [r11]|   [r11]|   [r11]|   [r11]|   [r11]|   [r11]|   [r11]|
+--+--------+--------+--------+--------+--------+--------+--------+
| 5|    [s9]|    [s3]|   [s10]|   [s11]|   [s12]|    [s4]|        |
+--+--------+--------+--------+--------+--------+--------+--------+
| 6|    [s9]|    [s3]|   [s10]|   [s11]|   [s12]|    [s4]|        |
+--+--------+--------+--------+--------+--------+--------+--------+
| 7|    [r4]|    [r4]|    [r4]|    [r4]|    [r4]|    [r4]|    [r4]|
+--+--------+--------+--------+--------+--------+--------+--------+
| 8|    [r3]|    [r3]|    [r3]|    [r3]|    [r3]|    [r3]|    [r3]|
+--+--------+--------+--------+--------+--------+--------+--------+
| 9|    [r2]|    [r2]|    [r2]|    [r2]|    [r2]|    [r2]|    [r2]|
+--+--------+--------+--------+--------+--------+--------+--------+
|10|        |        |        |   [s14]|        |        |        |
+--+--------+--------+--------+--------+--------+--------+--------+
|11|    [s9]|    [s3]|   [s10]|   [s11]|   [s12]|    [s4]|        |
+--+--------+--------+--------+--------+--------+--------+--------+
|12|   [r10]|   [r10]|   [r10]|   [r10]|   [r10]|   [r10]|   [r10]|
+--+--------+--------+--------+--------+--------+--------+--------+
|13|    [s9]|    [s3]|   [s10]|   [s11]|   [s12]|    [s4]|        |
+--+--------+--------+--------+--------+--------+--------+--------+
|14|   [s17]|        |        |        |        |        |        |
+--+--------+--------+--------+--------+--------+--------+--------+
|15|   [s19]|    [s3]|   [s20]|   [s11]|   [s12]|    [s4]|        |
+--+--------+--------+--------+--------+--------+--------+--------+
|16|    [r5]|    [r5]|    [r5]|    [r5]|    [r5]|    [r5]|    [r5]|
+--+--------+--------+--------+--------+--------+--------+--------+
|17|    [s9]|    [s3]|   [s10]|   [s11]|   [s12]|    [s4]|        |
+--+--------+--------+--------+--------+--------+--------+--------+
|18|    [r8]|    [r8]|    [r8]|    [r8]|    [r8]|    [r8]|    [r8]|
+--+--------+--------+--------+--------+--------+--------+--------+
|19|[r2, r9]|[r2, r9]|[r2, r9]|[r2, r9]|[r2, r9]|[r2, r9]|[r2, r9]|
+--+--------+--------+--------+--------+--------+--------+--------+
|20|        |        |        |   [s22]|        |        |        |
+--+--------+--------+--------+--------+--------+--------+--------+
|21|    [r6]|    [r6]|    [r6]|    [r6]|    [r6]|    [r6]|    [r6]|
+--+--------+--------+--------+--------+--------+--------+--------+
|22|   [s23]|        |        |        |        |        |        |
+--+--------+--------+--------+--------+--------+--------+--------+
|23|    [s9]|    [s3]|   [s10]|   [s11]|   [s12]|    [s4]|        |
+--+--------+--------+--------+--------+--------+--------+--------+
|24|    [r7]|    [r7]|    [r7]|    [r7]|    [r7]|    [r7]|    [r7]|
+--+--------+--------+--------+--------+--------+--------+--------+
```

```
+--+-------+-+--+-+
|  |$START$|S| R|M|
+--+-------+-+--+-+
| 0|       |1|  |2|
+--+-------+-+--+-+
| 1|       | |  | |
+--+-------+-+--+-+
| 2|       | |  | |
+--+-------+-+--+-+
| 3|       | |  |5|
+--+-------+-+--+-+
| 4|       | |  | |
+--+-------+-+--+-+
| 5|       | | 7|8|
+--+-------+-+--+-+
| 6|       | |13|8|
+--+-------+-+--+-+
| 7|       | |  | |
+--+-------+-+--+-+
| 8|       | |  | |
+--+-------+-+--+-+
| 9|       | |  | |
+--+-------+-+--+-+
|10|       | |  | |
+--+-------+-+--+-+
|11|       | |15|8|
+--+-------+-+--+-+
|12|       | |  | |
+--+-------+-+--+-+
|13|       | |16|8|
+--+-------+-+--+-+
|14|       | |  | |
+--+-------+-+--+-+
|15|       | |18|8|
+--+-------+-+--+-+
|16|       | |  | |
+--+-------+-+--+-+
|17|       | |21|8|
+--+-------+-+--+-+
|18|       | |  | |
+--+-------+-+--+-+
|19|       | |  | |
+--+-------+-+--+-+
|20|       | |  | |
+--+-------+-+--+-+
|21|       | |  | |
+--+-------+-+--+-+
|22|       | |  | |
+--+-------+-+--+-+
|23|       | |24|8|
+--+-------+-+--+-+
|24|       | |  | |
+--+-------+-+--+-+
```

